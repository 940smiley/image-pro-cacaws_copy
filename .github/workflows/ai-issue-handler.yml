name: AI Issue Handler

on:
  issues:
    types: [opened, reopened, labeled]

jobs:
  analyze_issue:
    runs-on: ubuntu-latest
    if: |
      (github.event.issue.user.login == 'dependabot[bot]') || 
      contains(github.event.issue.labels.*.name, 'needs-ai') ||
      contains(github.event.issue.labels.*.name, 'security')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini SDK
        run: npm install @google/generative-ai

      - name: Analyze Issue with Gemini
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.gemini_api_key }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # Run the script and capture output to a temporary file
          node scripts/ai_issue_handler.cjs > ai_response.md
          
          # Read file content into a variable (handling multiline)
          echo "RESPONSE<<EOF" >> $GITHUB_ENV
          cat ai_response.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.gh_token }}
          script: |
            const response = process.env.RESPONSE;
            if (response) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "## ðŸ¤– Gemini AI Analysis\n\n" + response
              });
            }
